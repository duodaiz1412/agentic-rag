services:
  agentic-rag:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: agentic-rag-api
    ports:
      - "8002:8002"
    environment:
      # API Keys (set these in .env file or override in docker-compose)
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY}
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2:-false}
      - LANGCHAIN_PROJECT=${LANGCHAIN_PROJECT:-agentic-rag}
      
      # DeepSeek rate limit
      - DEEPSEEK_RATE_LIMIT_PER_MINUTE=${DEEPSEEK_RATE_LIMIT_PER_MINUTE:-100}
      
      # Database connection - Connect to Backend PostgreSQL service
      # Use service name 'db' from Backend docker-compose.yml
      - RAG_DB_HOST=db
      - RAG_DB_PORT=5432
      - RAG_DB_NAME=postgres
      - RAG_DB_USER=postgres
      - RAG_DB_PASSWORD=postgres
      - RAG_DB_CONNECT_TIMEOUT=10
      
      # Vector store
      - CHROMA_COLLECTION_NAME=${CHROMA_COLLECTION_NAME:-rag-edtech}
      - CHROMA_PERSIST_DIR=${CHROMA_PERSIST_DIR:-/app/.chroma}
      - RAG_CHUNK_SIZE=${RAG_CHUNK_SIZE:-700}
      - RAG_CHUNK_OVERLAP=${RAG_CHUNK_OVERLAP:-120}
      
      # Knowledge base
      - KNOWLEDGE_BASE_DIR=${KNOWLEDGE_BASE_DIR:-/app/knowledge-base}
      - USER_AGENT=${USER_AGENT:-agentic-rag/0.1 (docker)}
    volumes:
      # Persist ChromaDB data
      - chroma-data:/app/.chroma
      # Mount knowledge-base if you want to update it without rebuilding
      - ./knowledge-base:/app/knowledge-base:ro
    restart: unless-stopped
    # Connect to Backend's network to access PostgreSQL
    networks:
      - compose_lms_network

volumes:
  chroma-data:

# Use Backend's existing network (created by Backend docker-compose)
networks:
  compose_lms_network:
    external: true

